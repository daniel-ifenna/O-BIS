module.exports=[58823,e=>{"use strict";var t=e.i(47909),r=e.i(74017),i=e.i(96250),a=e.i(59756),n=e.i(61916),o=e.i(14444),s=e.i(37092),d=e.i(69741),l=e.i(16795),u=e.i(87718),p=e.i(95169),c=e.i(47587),m=e.i(66012),g=e.i(70101),h=e.i(26937),f=e.i(10372),v=e.i(93695);e.i(52474);var R=e.i(220),w=e.i(89171),y=e.i(36632),I=e.i(62294),E=e.i(53905),b=e.i(27087);function N(e){let t=e.headers.get("authorization")||"",r=/^Bearer\s+(.+)$/i.exec(t);if(!r)return null;let i=(0,y.verifyToken)(r[1]);return i?{userId:i.sub,role:i.role}:null}let T=/^(https:\/\/)(meet\.google\.com|teams\.microsoft\.com|zoom\.us)\/.+/i;function x(e,t){let[r,i,a]=e.split("-").map(e=>Number(e)),[n,o]=t.split(":").map(e=>Number(e)),s=new Date(Date.UTC(r,(i||1)-1,a||1,n||0,o||0,0)),d=e=>String(e).padStart(2,"0");return`${s.getUTCFullYear()}${d(s.getUTCMonth()+1)}${d(s.getUTCDate())}T${d(s.getUTCHours())}${d(s.getUTCMinutes())}${d(s.getUTCSeconds())}Z`}async function A(e,{params:t}){try{let r=N(e);if(!r||"manager"!==r.role&&"MANAGER"!==r.role&&"admin"!==r.role&&"ADMIN"!==r.role)return w.NextResponse.json({error:"Forbidden"},{status:403});let{id:i}=await t,a=await I.prisma.bidInvitation.findMany({where:{bidId:i},orderBy:{createdAt:"desc"}});return w.NextResponse.json(a)}catch(e){return w.NextResponse.json({error:String(e?.message||"Failed to load invitations")},{status:500})}}async function C(e,{params:t}){try{let r=N(e);if(!r||"manager"!==r.role&&"MANAGER"!==r.role&&"admin"!==r.role&&"ADMIN"!==r.role)return w.NextResponse.json({error:"Forbidden"},{status:403});let{id:i}=await t,a=await e.json().catch(()=>({})),n=a.meetingTitle||"Bid Review Meeting",o=a.date,s=a.time,d=function(e){let t=String(e||"").trim();if(!t)return"";if(/^https?:\/\//i.test(t))return t;let r=t.toLowerCase().replace(/\s+/g,"").replace(/[^a-z0-9\-]/g,"");return r.length>=3?`https://meet.google.com/${r}`:t}(a.googleMeetLink||""),l=a.message,u=Array.isArray(a.attendees)?a.attendees:[],p=a.ownerName||"Project Manager",c="string"==typeof a.timeZone?a.timeZone:void 0,m=!!a.includeAllShortlisted;if(!o||!s||!d)return w.NextResponse.json({error:"date, time, and meeting link are required"},{status:400});if(!T.test(d))return w.NextResponse.json({error:"Invalid meeting link"},{status:400});let g=await I.prisma.bid.findUnique({where:{id:i}});if(g||(g=await (0,b.getBidById)(i)),!g)return w.NextResponse.json({error:"Bid not found"},{status:404});let h=await I.prisma.project.findUnique({where:{id:g.projectId}});if(h||(h=await (0,b.getProjectById)(g.projectId)),!h)return w.NextResponse.json({error:"Project not found"},{status:404});let f=!1;try{let e=await I.prisma.manager.findUnique({where:{id:h.managerId}});f=String(e?.userId||"")===String(r.userId)}catch{}let v="admin"===r.role||"ADMIN"===r.role;if(!f&&!v&&String(h.managerId||"")!==String(r.userId))return w.NextResponse.json({error:"Unauthorized: not project manager"},{status:403});if(!m&&"Reviewed"!==g.status)try{await I.prisma.bid.update({where:{id:i},data:{status:"Reviewed",reviewedAt:new Date}})}catch{}let R=new Set([g.email,...u].filter(Boolean));try{let e=await I.prisma.manager.findUnique({where:{id:h.managerId},include:{user:!0}}),t=e?.user?.name||null;!a.ownerName&&t&&(p=t)}catch{}let y=`Bid Review Meeting – ${h.title}`,A=[g.email,...u].filter(Boolean).join(", "),C=[],S=[],j=async(e,t,r)=>{let i;if(await I.prisma.bidInvitation.findFirst({where:{bidId:e.id,date:o,time:s}}))return C.push({bidId:e.id,to:t,ok:!1,skippedDuplicate:!0}),!1;let a=function({title:e,date:t,time:r,link:i,description:a,attendees:n}){let o=`inv-${Date.now()}@nexus-construct`,s=x(t,r),d=x(t,r),l=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Nexus Construct//EN","METHOD:REQUEST","BEGIN:VEVENT",`UID:${o}`,`DTSTAMP:${s}`,`DTSTART:${s}`,`DTEND:${d}`,`SUMMARY:${e.replace(/\r?\n/g," ")}`,`DESCRIPTION:${((a||"")+"\\n"+i).replace(/\r?\n/g," ")}`,`LOCATION:${i}`];for(let e of n)l.push(`ATTENDEE;ROLE=REQ-PARTICIPANT;RSVP=TRUE:mailto:${e}`);return l.push("END:VEVENT","END:VCALENDAR"),l.join("\r\n")}({title:n,date:o,time:s,link:d,description:l,attendees:[t,...u].filter(Boolean)}),m=await E.emailService.sendMeetingInviteEmail({to:t,subject:y,html:(i=`
              <p style="margin:0 0 12px 0">Dear ${r},</p>
              <p style="margin:0 0 12px 0">You have been shortlisted for the bid review meeting for the project <strong>${h.title}</strong>.</p>
              <div style="margin:16px 0;padding:12px;border:1px solid #e5e7eb;border-radius:8px;background:#fafafa">
                <div style="margin:4px 0"><span style="color:#6b7280">Meeting Owner:</span> <span style="font-weight:600">${p}</span></div>
                <div style="margin:4px 0"><span style="color:#6b7280">Date & Time (UTC):</span> <span style="font-weight:600">${o} ${s}</span></div>
                <div style="margin:4px 0"><span style="color:#6b7280">Local Time${c?` (${c})`:""}:</span> <span style="font-weight:600">${(()=>{try{let[e,t,r]=o.split("-").map(e=>Number(e)),[i,a]=s.split(":").map(e=>Number(e)),n=new Date(Date.UTC(e,(t||1)-1,r||1,i||0,a||0));if(c)return new Intl.DateTimeFormat("en-US",{timeZone:c,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).format(n)}catch{}return`${o} ${s}`})()}</span></div>
                <div style="margin:4px 0"><span style="color:#6b7280">Attendees:</span> <span style="font-weight:600">${A}</span></div>
                <div style="margin:4px 0"><span style="color:#6b7280">Message:</span> <span style="font-weight:600">${l||"None"}</span></div>
              </div>
              <p style="margin:16px 0;color:#6b7280">An ICS calendar invite is attached to this email.</p>`,E.emailService.buildHtmlTemplate({preheader:`Bid Review Meeting – ${h.title}`,title:`Bid Review Meeting – ${h.title}`,bodyHtml:i,ctaText:"Join Meeting",ctaUrl:d})),icsContent:a});return C.push({bidId:e.id,to:t,ok:m}),m};if(m)for(let e of(await I.prisma.bid.findMany({where:{projectId:g.projectId,status:"Reviewed"}}))){let t=e.email;if(!t)continue;await j(e,t,e.bidderName);let r=[t,...Array.from(R)].filter(Boolean);S.push({bidId:e.id,sentTo:r});try{await I.prisma.bidInvitation.create({data:{bidId:e.id,projectId:g.projectId,meetingTitle:n,date:o,time:s,googleMeetLink:d,message:l,attendees:u,sentTo:r}})}catch{await (0,b.addBidInvitation)({bidId:e.id,projectId:String(g.projectId),meetingTitle:n,date:o,time:s,googleMeetLink:d,message:l,attendees:u,sentTo:r})}}else{let e=g.email,t=await j(g,e,g.bidderName),r=[e,...Array.from(R)].filter(Boolean);if(S.push({bidId:g.id,sentTo:r}),t)try{await I.prisma.bidInvitation.create({data:{bidId:i,projectId:g.projectId,meetingTitle:n,date:o,time:s,googleMeetLink:d,message:l,attendees:u,sentTo:r}})}catch{await (0,b.addBidInvitation)({bidId:i,projectId:String(g.projectId),meetingTitle:n,date:o,time:s,googleMeetLink:d,message:l,attendees:u,sentTo:r})}}let D=C.filter(e=>!e.skippedDuplicate).every(e=>e.ok);if(C.some(e=>e.ok))try{await I.prisma.project.update({where:{id:g.projectId},data:{status:"Closed"}})}catch(e){console.error("Failed to close project after invite:",e)}return w.NextResponse.json({ok:D,results:C})}catch(e){return w.NextResponse.json({error:String(e?.message||"Failed to send meeting invite")},{status:500})}}e.s(["GET",()=>A,"POST",()=>C],49109);var S=e.i(49109);let j=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/bids/[id]/invite-meeting/route",pathname:"/api/bids/[id]/invite-meeting",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/bids/[id]/invite-meeting/route.ts",nextConfigOutput:"",userland:S}),{workAsyncStorage:D,workUnitAsyncStorage:$,serverHooks:M}=j;function U(){return(0,i.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:$})}async function P(e,t,i){j.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/bids/[id]/invite-meeting/route";w=w.replace(/\/index$/,"")||"/";let y=await j.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:I,params:E,nextConfig:b,parsedUrl:N,isDraftMode:T,prerenderManifest:x,routerServerContext:A,isOnDemandRevalidate:C,revalidateOnlyGenerated:S,resolvedPathname:D,clientReferenceManifest:$,serverActionsManifest:M}=y,U=(0,d.normalizeAppPath)(w),P=!!(x.dynamicRoutes[U]||x.routes[D]),O=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,N,!1):t.end("This page could not be found"),null);if(P&&!T){let e=!!x.routes[D],t=x.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await O();throw new v.NoFallbackError}}let k=null;!P||j.isDev||T||(k="/index"===(k=D)?"/":k);let B=!0===j.isDev||!P,H=P&&!B;M&&$&&(0,o.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:$,serverActionsManifest:M,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:M})});let _=e.method||"GET",q=(0,n.getTracer)(),F=q.getActiveScopeSpan(),L={params:E,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:B,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,i)=>j.onRequestError(e,t,i,A)},sharedContext:{buildId:I}},V=new l.NodeNextRequest(e),G=new l.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(V,(0,u.signalFromNodeResponse)(t));try{let o=async e=>j.handle(K,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=q.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${_} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${_} ${w}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),d=async a=>{var n,d;let l=async({previousCacheEntry:r})=>{try{if(!s&&C&&S&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(a);e.fetchMetrics=L.renderOpts.fetchMetrics;let d=L.renderOpts.pendingWaitUntil;d&&i.waitUntil&&(i.waitUntil(d),d=void 0);let l=L.renderOpts.collectedTags;if(!P)return await (0,m.sendResponse)(V,G,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[f.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,i=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==r?void 0:r.isStale)&&await j.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})},A),t}},u=await j.handleResponse({req:e,nextConfig:b,cacheKey:k,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:S,responseGenerator:l,waitUntil:i.waitUntil,isMinimalMode:s});if(!P)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",C?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&P||p.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(V,G,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};F?await d(F):await q.withPropagatedContext(e.headers,()=>q.trace(p.BaseServerSpan.handleRequest,{spanName:`${_} ${w}`,kind:n.SpanKind.SERVER,attributes:{"http.method":_,"http.target":e.url}},d))}catch(t){if(t instanceof v.NoFallbackError||await j.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})}),P)throw t;return await (0,m.sendResponse)(V,G,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>U,"routeModule",()=>j,"serverHooks",()=>M,"workAsyncStorage",()=>D,"workUnitAsyncStorage",()=>$],58823)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_66945d21.js.map