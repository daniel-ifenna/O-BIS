{"version":3,"sources":["../../../lib/storage.ts"],"sourcesContent":["import admin from \"firebase-admin\"\nimport type { Bucket } from \"@google-cloud/storage\"\n\nexport type StorageCategory =\n  | \"bidding-documents\"\n  | \"technical-proposals\"\n  | \"financial-proposals\"\n  | \"procurement-specifications\"\n  | \"vendor-quotations\"\n  | \"contracts\"\n  | \"progress-photos\"\n  | \"proof-of-delivery\"\n\nexport type FirebaseConfig = {\n  projectId: string\n  clientEmail: string\n  privateKey: string\n  bucket: string\n}\n\nexport type UploadOptions = {\n  category: StorageCategory\n  filename: string\n  contentType: string\n  projectId?: string\n  bidId?: string\n  procurementId?: string\n  vendorId?: string\n  userId?: string\n  cacheControl?: string\n  makePublic?: boolean\n  gzip?: boolean\n  metadata?: Record<string, string>\n}\n\nexport type UploadResult = {\n  path: string\n  size: number\n  contentType: string\n  md5Hash?: string\n  generation?: string\n  etag?: string\n  mediaLink?: string\n  publicUrl?: string\n  signedUrl?: string\n}\n\nconst allowedMime = new Set<string>([\n  \"application/pdf\",\n  \"application/msword\",\n  \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n  \"application/vnd.ms-excel\",\n  \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n  \"text/csv\",\n  \"image/jpeg\",\n  \"image/png\",\n])\n\nfunction sanitize(name: string): string {\n  return name\n    .toLowerCase()\n    .replace(/[^a-z0-9_.-]+/g, \"-\")\n    .replace(/-+/g, \"-\")\n    .replace(/^-|-$|^\\.|\\.$/g, \"\")\n}\n\nfunction ts(): string {\n  return new Date().toISOString().replace(/[^0-9]/g, \"\")\n}\n\nfunction buildPath(o: UploadOptions): string {\n  const parts: string[] = [o.category]\n  if (o.projectId) parts.push(`project_${o.projectId}`)\n  if (o.bidId) parts.push(`bid_${o.bidId}`)\n  if (o.procurementId) parts.push(`proc_${o.procurementId}`)\n  if (o.vendorId) parts.push(`vendor_${o.vendorId}`)\n  if (o.userId) parts.push(`user_${o.userId}`)\n  const name = `${ts()}-${sanitize(o.filename)}`\n  parts.push(name)\n  return parts.join(\"/\")\n}\n\nclass FirebaseStorage {\n  private bucket: Bucket\n\n  constructor(cfg: FirebaseConfig) {\n    if (!admin.apps.length) {\n      admin.initializeApp({\n        credential: admin.credential.cert({\n          projectId: cfg.projectId,\n          clientEmail: cfg.clientEmail,\n          privateKey: cfg.privateKey.replace(/\\\\n/g, \"\\n\"),\n        }),\n        storageBucket: cfg.bucket,\n      })\n    }\n    this.bucket = admin.storage().bucket(cfg.bucket)\n  }\n\n  async uploadBuffer(buf: Buffer, opts: UploadOptions): Promise<UploadResult> {\n    if (!allowedMime.has(opts.contentType)) throw new Error(\"Unsupported content type\")\n    const path = buildPath(opts)\n    const file = this.bucket.file(path)\n    await file.save(buf, {\n      contentType: opts.contentType,\n      gzip: opts.gzip ?? true,\n      resumable: false,\n      metadata: { cacheControl: opts.cacheControl ?? \"public, max-age=31536000\", metadata: opts.metadata },\n    })\n    if (opts.makePublic) await file.makePublic()\n    const [meta] = await file.getMetadata()\n    const res: UploadResult = {\n      path,\n      size: Number(meta.size || 0),\n      contentType: meta.contentType || opts.contentType,\n      md5Hash: meta.md5Hash,\n      generation: meta.generation ? String(meta.generation) : undefined,\n      etag: meta.etag,\n      mediaLink: meta.mediaLink,\n      publicUrl: opts.makePublic ? this.getPublicUrl(path) : undefined,\n    }\n    return res\n  }\n\n  async uploadStream(readable: NodeJS.ReadableStream, opts: UploadOptions): Promise<UploadResult> {\n    if (!allowedMime.has(opts.contentType)) throw new Error(\"Unsupported content type\")\n    const path = buildPath(opts)\n    const file = this.bucket.file(path)\n    const ws = file.createWriteStream({\n      contentType: opts.contentType,\n      gzip: opts.gzip ?? true,\n      resumable: false,\n      metadata: { cacheControl: opts.cacheControl ?? \"public, max-age=31536000\", metadata: opts.metadata },\n    })\n    return new Promise<UploadResult>((resolve, reject) => {\n      ws.on(\"error\", reject)\n      ws.on(\"finish\", async () => {\n        try {\n          if (opts.makePublic) await file.makePublic()\n          const [meta] = await file.getMetadata()\n          resolve({\n            path,\n            size: Number(meta.size || 0),\n            contentType: meta.contentType || opts.contentType,\n            md5Hash: meta.md5Hash,\n            generation: meta.generation ? String(meta.generation) : undefined,\n            etag: meta.etag,\n            mediaLink: meta.mediaLink,\n            publicUrl: opts.makePublic ? this.getPublicUrl(path) : undefined,\n          })\n        } catch (e) {\n          reject(e)\n        }\n      })\n      readable.pipe(ws)\n    })\n  }\n\n  async getSignedUrl(path: string, expiresInSeconds: number = 3600): Promise<string> {\n    const file = this.bucket.file(path)\n    const options = { action: \"read\", expires: Date.now() + expiresInSeconds * 1000 } as any\n    const [url] = await file.getSignedUrl(options)\n    return url\n  }\n\n  getPublicUrl(path: string): string {\n    return `https://storage.googleapis.com/${this.bucket.name}/${path}`\n  }\n\n  async delete(path: string): Promise<void> {\n    const file = this.bucket.file(path)\n    await file.delete({ ignoreNotFound: true })\n  }\n\n  async exists(path: string): Promise<boolean> {\n    const file = this.bucket.file(path)\n    const [ok] = await file.exists()\n    return ok\n  }\n\n  async copy(srcPath: string, destPath: string): Promise<void> {\n    const src = this.bucket.file(srcPath)\n    const dest = this.bucket.file(destPath)\n    await src.copy(dest)\n  }\n\n  async move(srcPath: string, destPath: string): Promise<void> {\n    await this.copy(srcPath, destPath)\n    await this.delete(srcPath)\n  }\n\n  async getMetadata(path: string): Promise<Record<string, unknown>> {\n    const file = this.bucket.file(path)\n    const [meta] = await file.getMetadata()\n    return meta\n  }\n}\n\nexport function createFirebaseStorageFromEnv(): FirebaseStorage {\n  const projectId = process.env.FIREBASE_PROJECT_ID || \"\"\n  const clientEmail = process.env.FIREBASE_CLIENT_EMAIL || \"\"\n  const privateKey = (process.env.FIREBASE_PRIVATE_KEY || \"\").replace(/\\r?\\n/g, \"\\n\")\n  const bucket = process.env.FIREBASE_STORAGE_BUCKET || \"\"\n  if (!projectId || !clientEmail || !privateKey || !bucket) throw new Error(\"Missing Firebase credentials\")\n  return new FirebaseStorage({ projectId, clientEmail, privateKey, bucket })\n}\n\nexport { FirebaseStorage }\n"],"names":[],"mappings":"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"}