{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/constructionplatform%20%281%29/lib/db.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\n\nconst globalForPrisma = globalThis as unknown as { prisma?: PrismaClient }\n\nconst dbUrl = process.env.DATABASE_URL_PGBOUNCER || process.env.DATABASE_URL || \"\"\n\nfunction createPrismaOrMock(): PrismaClient | any {\n  if (dbUrl) {\n    return new PrismaClient({\n      datasources: {\n        db: { url: dbUrl },\n      },\n    })\n  }\n  const warn = (op: string) => {\n    throw new Error(`Database unavailable: set DATABASE_URL before calling ${op}`)\n  }\n  return new Proxy(\n    {},\n    {\n      get(_, prop) {\n        if (prop === \"$use\") return () => {}\n        if (prop === \"$transaction\") return () => warn(\"$transaction\")\n        return () => warn(String(prop))\n      },\n    },\n  ) as PrismaClient\n}\n\nexport const prisma = globalForPrisma.prisma || createPrismaOrMock()\n\nif (!globalForPrisma.prisma) globalForPrisma.prisma = prisma\n\nfunction fmtDate(d: Date): string {\n  const y = d.getFullYear()\n  const m = String(d.getMonth() + 1).padStart(2, \"0\")\n  const day = String(d.getDate()).padStart(2, \"0\")\n  return `${y}-${m}-${day}`\n}\n\nfunction fmtTime(d: Date): string {\n  const h = String(d.getHours()).padStart(2, \"0\")\n  const min = String(d.getMinutes()).padStart(2, \"0\")\n  return `${h}:${min}`\n}\n\nconst TARGET_MODELS = new Set([\n  \"User\",\n  \"Contractor\",\n  \"Vendor\",\n  \"Manager\",\n  \"Project\",\n  \"Bid\",\n  \"BidInvitation\",\n  \"ProcurementRequest\",\n  \"EscrowWalletTransaction\",\n  \"FileStorageRecord\",\n  \"PaymentRequest\",\n  \"Milestone\",\n  \"DailyReport\",\n  \"VendorQuote\",\n])\n\nif (typeof (prisma as any).$use === \"function\") (prisma as any).$use(async (params: any, next: any) => {\n  const now = new Date()\n  const date = fmtDate(now)\n  const time = fmtTime(now)\n  const modelMatches = TARGET_MODELS.has(params.model || \"\")\n  const preventDeletes = String(process.env.ALLOW_DELETE || \"\").toLowerCase() !== \"true\"\n  if (preventDeletes && (params.action === \"delete\" || params.action === \"deleteMany\")) {\n    throw new Error(\"Delete operations are disabled\")\n  }\n\n  if (modelMatches) {\n    if (params.action === \"create\") {\n      params.args.data = { ...(params.args.data || {}), recordDate: date, recordTime: time }\n    } else if (params.action === \"createMany\") {\n      const data = params.args.data\n      if (Array.isArray(data)) {\n        params.args.data = data.map((item: any) => ({ ...(item || {}), recordDate: date, recordTime: time }))\n      } else {\n        params.args.data = { ...(data || {}), recordDate: date, recordTime: time }\n      }\n    } else if (params.action === \"update\" || params.action === \"upsert\") {\n      params.args.data = { ...(params.args.data || {}), recordDate: date, recordTime: time }\n    } else if (params.action === \"updateMany\") {\n      const data = params.args.data\n      params.args.data = { ...(data || {}), recordDate: date, recordTime: time }\n    }\n  }\n\n  return next(params)\n})\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 180, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/constructionplatform%20%281%29/lib/auth/jwt.ts"],"sourcesContent":["import jwt from \"jsonwebtoken\"\n\ntype Payload = { sub: string; role: \"manager\" | \"contractor\" | \"vendor\" }\n\nexport function signToken(payload: Payload, expiresIn: string = process.env.JWT_EXPIRES_IN || \"1h\") {\n  const secret = process.env.JWT_SECRET || \"\"\n  if (!secret) throw new Error(\"Missing JWT_SECRET\")\n  return jwt.sign(payload, secret as jwt.Secret, { algorithm: \"HS256\", expiresIn } as jwt.SignOptions)\n}\n\nexport function verifyToken(token: string): Payload | null {\n  const secret = process.env.JWT_SECRET || \"\"\n  if (!secret) throw new Error(\"Missing JWT_SECRET\")\n  try {\n    return jwt.verify(token, secret) as Payload\n  } catch {\n    return null\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAIO,SAAS,UAAU,OAAgB,EAAE,YAAoB,QAAQ,GAAG,CAAC,cAAc,IAAI,IAAI;IAChG,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU,IAAI;IACzC,IAAI,CAAC,QAAQ,MAAM,IAAI,MAAM;IAC7B,OAAO,kJAAG,CAAC,IAAI,CAAC,SAAS,QAAsB;QAAE,WAAW;QAAS;IAAU;AACjF;AAEO,SAAS,YAAY,KAAa;IACvC,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU,IAAI;IACzC,IAAI,CAAC,QAAQ,MAAM,IAAI,MAAM;IAC7B,IAAI;QACF,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAM;QACN,OAAO;IACT;AACF"}},
    {"offset": {"line": 299, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/constructionplatform%20%281%29/lib/utils/email-templates.ts"],"sourcesContent":["export type EmailContent = { subject: string; html: string; text: string }\nfunction nowTs() { return new Date().toLocaleString() }\nfunction wrap(subject: string, title: string, body: string, preheader?: string) {\n  const ph = preheader || subject\n  return `<!DOCTYPE html><html><body style=\"margin:0;padding:0;background:#f7f7f7;font-family:Inter,Arial,sans-serif;color:#1f2937\"><div style=\"display:none;max-height:0;overflow:hidden\">${ph}</div><table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"background:#f7f7f7\"><tr><td align=\"center\" style=\"padding:24px\"><table role=\"presentation\" width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border-radius:12px;border:1px solid #e5e7eb\"><tr><td style=\"padding:24px;border-bottom:1px solid #e5e7eb\"><div style=\"display:flex;align-items:center;gap:8px\"><div style=\"width:32px;height:32px;border-radius:8px;background:#ea580c\"></div><div style=\"font-weight:700;color:#0f172a\">Open-Eye Africa Technologies – O-BIS</div></div></td></tr><tr><td style=\"padding:24px\"><h2 style=\"margin:0 0 8px 0;color:#0f172a\">${title}</h2>${body}<div style=\"margin-top:16px;color:#6b7280;font-size:12px\">Timestamp: ${nowTs()}</div></td></tr><tr><td style=\"padding:16px 24px;border-top:1px solid #e5e7eb;color:#6b7280;font-size:12px\">© ${new Date().getFullYear()} Open-Eye Africa Technologies. All rights reserved.</td></tr></table></td></tr></table></body></html>`\n}\n\nfunction currency(amount: number | string) {\n  const n = Number(amount || 0)\n  try {\n    return new Intl.NumberFormat(\"en-NG\", { style: \"currency\", currency: \"NGN\" }).format(n)\n  } catch {\n    return `₦${n.toFixed(2)}`\n  }\n}\n\nexport function paymentApprovedEmail(params: { recipientName: string; amount: number | string; managerName: string; reference?: string; ctaLink?: string }): EmailContent {\n  const amt = currency(params.amount)\n  const subject = \"Payment Request Approved – Funds Released\"\n  const content = `<p>Dear ${params.recipientName},</p><p>We are pleased to inform you that your payment request for <strong>${amt}</strong> has been <strong>approved</strong> by ${params.managerName}.</p><p>${params.reference ? `Reference: ${params.reference}` : \"\"}</p><p>The approved funds have now been credited to your wallet.</p>${params.ctaLink ? `<p><a href=\"${params.ctaLink}\" style=\"display:inline-block;padding:12px 18px;background:#ea580c;color:#fff;text-decoration:none;border-radius:6px\">View Wallet</a></p>` : \"\"}<p>Best regards,<br>O-BIS Management Team</p>`\n  const html = wrap(subject, \"Payment Approved\", content)\n  const text = `Dear ${params.recipientName},\\nYour payment request for ${amt} has been approved by ${params.managerName} and the funds have been credited to your wallet.\\nBest regards,\\nO-BIS Management Team`\n  return { subject, html, text }\n}\n\nexport function paymentRejectedEmail(params: { recipientName: string; amount: number | string; managerName: string; reason: string; reference?: string }): EmailContent {\n  const amt = currency(params.amount)\n  const subject = \"Payment Request Update – Rejected\"\n  const content = `<p>Dear ${params.recipientName},</p><p>Your payment request for <strong>${amt}</strong> has unfortunately been <strong>rejected</strong> by ${params.managerName}.</p><p>${params.reference ? `Reference: ${params.reference}` : \"\"}</p><p>Reason provided: ${params.reason}</p><p>You may contact your manager if you need further clarification.</p><p>Best regards,<br>O-BIS Management Team</p>`\n  const html = wrap(subject, \"Payment Rejected\", content)\n  const text = `Dear ${params.recipientName},\\nYour payment request for ${amt} has been rejected by ${params.managerName}.\\nReason: ${params.reason}\\nBest regards,\\nO-BIS Management Team`\n  return { subject, html, text }\n}\n\nexport function internalTransferEmail(params: { recipientName: string; amount: number | string; managerName: string; reference?: string; ctaLink?: string }): EmailContent {\n  const amt = currency(params.amount)\n  const subject = \"Funds Transferred to Your Wallet\"\n  const content = `<p>Dear ${params.recipientName},</p><p>This is to notify you that <strong>${amt}</strong> has been transferred to your wallet by ${params.managerName}.</p><p>${params.reference ? `Reference: ${params.reference}` : \"\"}</p><p>You can now view this amount in your wallet balance.</p>${params.ctaLink ? `<p><a href=\"${params.ctaLink}\" style=\"display:inline-block;padding:12px 18px;background:#ea580c;color:#fff;text-decoration:none;border-radius:6px\">View Wallet</a></p>` : \"\"}<p>Best regards,<br>O-BIS Management Team</p>`\n  const html = wrap(subject, \"Wallet Credited\", content)\n  const text = `Dear ${params.recipientName},\\n${amt} has been transferred to your wallet by ${params.managerName}.\\nBest regards,\\nO-BIS Management Team`\n  return { subject, html, text }\n}\n\nexport function adminDepositEmail(params: { managerName: string; amount: number | string; reference?: string; ctaLink?: string }): EmailContent {\n  const amt = currency(params.amount)\n  const subject = \"Virtual Deposit Added to Your Wallet\"\n  const content = `<p>Dear ${params.managerName},</p><p>A virtual deposit of <strong>${amt}</strong> has been added to your wallet for administrative or project allocation purposes.</p><p>${params.reference ? `Reference: ${params.reference}` : \"\"}</p><p>This deposit was issued by the system administrator.</p>${params.ctaLink ? `<p><a href=\"${params.ctaLink}\" style=\"display:inline-block;padding:12px 18px;background:#ea580c;color:#fff;text-decoration:none;border-radius:6px\">View Wallet</a></p>` : \"\"}<p>Best regards,<br>O-BIS Management Team</p>`\n  const html = wrap(subject, \"Wallet Credited\", content)\n  const text = `Dear ${params.managerName},\\nA virtual deposit of ${amt} has been added to your wallet by the system administrator.\\nBest regards,\\nO-BIS Management Team`\n  return { subject, html, text }\n}\n\nexport function shortlistedEmail(params: { contractorName: string; managerName: string; projectName: string; meetingLink: string; bidAmount?: number | string; duration?: number | string }): EmailContent {\n  const amt = params.bidAmount != null ? currency(params.bidAmount) : \"N/A\"\n  const subject = \"You Have Been Shortlisted – Meeting Invitation\"\n  const content = `<p>Dear ${params.contractorName},</p><p>On behalf of ${params.managerName}, we are pleased to notify you that your bid for <strong>${params.projectName}</strong> has been <strong>shortlisted</strong>.</p><p>You are hereby invited to the scheduled meeting.</p><p><strong>Join the meeting:</strong> <a href=\"${params.meetingLink}\">${params.meetingLink}</a></p><p><strong>Bid Amount:</strong> ${amt}<br><strong>Project Duration:</strong> ${params.duration ?? \"N/A\"}</p><p>Best regards,<br>O-BIS Management Team</p>`\n  const html = wrap(subject, \"Shortlisted – Meeting Invitation\", content)\n  const text = `Dear ${params.contractorName},\\nOn behalf of ${params.managerName}, your bid for ${params.projectName} has been shortlisted.\\nJoin meeting: ${params.meetingLink}\\nBid amount: ${amt}\\nDuration: ${params.duration ?? \"N/A\"}\\nBest regards,\\nO-BIS Management Team`\n  return { subject, html, text }\n}\n\nexport function walletDebitedEmail(params: { recipientName: string; amount: number | string; managerName: string; reason?: string; reference?: string }): EmailContent {\n  const amt = currency(params.amount)\n  const subject = \"Wallet Debited – Transfer Processed\"\n  const content = `<p>Dear ${params.recipientName},</p><p>Your wallet has been debited with <strong>${amt}</strong>${params.managerName ? ` by ${params.managerName}` : \"\"}.${params.reason ? ` Reason: ${params.reason}.` : \"\"}</p><p>${params.reference ? `Reference: ${params.reference}` : \"\"}</p><p>If you did not expect this debit, please contact support.</p><p>Best regards,<br>O-BIS Management Team</p>`\n  const html = wrap(subject, \"Wallet Debited\", content)\n  const text = `Dear ${params.recipientName},\\nYour wallet has been debited with ${amt}${params.managerName ? ` by ${params.managerName}` : \"\"}.${params.reason ? ` Reason: ${params.reason}.` : \"\"}\\nBest regards,\\nO-BIS Management Team`\n  return { subject, html, text }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 407, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/constructionplatform%20%281%29/lib/bid-review.ts"],"sourcesContent":["import { google } from \"googleapis\"\nimport nodemailer from \"nodemailer\"\nimport PDFDocument from \"pdfkit\"\nimport { format } from \"date-fns\"\nimport { shortlistedEmail } from \"@/lib/utils/email-templates\"\n\nexport type Bid = {\n  contactPerson: string\n  email: string\n  projectName: string\n  companyName?: string\n  estimatedBudget?: string | number\n  estimatedDuration?: number\n  description?: string\n  subcontractors?: Array<{ name: string; company?: string; scope?: string }>\n  meetingDate?: string\n  meetingTime?: string\n}\n\nexport type InvitationEmail = { subject: string; html: string }\nexport type AwardEmail = { subject: string; html: string }\nexport type CalendarEventResult = { eventId: string; hangoutLink?: string; htmlLink?: string; start: string; end: string }\n\nfunction toISO(date: string, time: string) {\n  const [y, m, d] = date.split(\"-\").map((v) => Number(v))\n  const [hh, mm] = time.split(\":\" ).map((v) => Number(v))\n  const dt = new Date(y, (m || 1) - 1, d || 1, hh || 0, mm || 0, 0)\n  return dt.toISOString()\n}\n\nexport function generateInvitationEmail(bid: Bid, ownerName: string, timeZone: string, googleMeetLink: string): InvitationEmail {\n  const email = shortlistedEmail({ contractorName: bid.contactPerson, managerName: ownerName, projectName: bid.projectName, meetingLink: googleMeetLink, bidAmount: bid.estimatedBudget, duration: bid.estimatedDuration })\n  return { subject: email.subject, html: email.html }\n}\n\nexport async function createGoogleMeetEvent(bid: Bid, ownerName: string, timeZone: string, attendees: string[] = []): Promise<CalendarEventResult> {\n  const clientId = process.env.GOOGLE_CLIENT_ID || \"\"\n  const clientSecret = process.env.GOOGLE_CLIENT_SECRET || \"\"\n  const refreshToken = process.env.GOOGLE_REFRESH_TOKEN || \"\"\n  const calendarId = process.env.GOOGLE_CALENDAR_ID || \"primary\"\n  if (!clientId || !clientSecret || !refreshToken) throw new Error(\"Missing Google OAuth credentials\")\n  if (!bid.meetingDate || !bid.meetingTime) throw new Error(\"Missing meetingDate or meetingTime\")\n  const oauth2Client = new google.auth.OAuth2(clientId, clientSecret)\n  oauth2Client.setCredentials({ refresh_token: refreshToken })\n  const calendar = google.calendar({ version: \"v3\", auth: oauth2Client })\n  const startIso = toISO(bid.meetingDate, bid.meetingTime)\n  const start = { dateTime: startIso, timeZone }\n  const endIso = toISO(bid.meetingDate, bid.meetingTime)\n  const endDate = new Date(endIso)\n  endDate.setHours(endDate.getHours() + 1)\n  const end = { dateTime: endDate.toISOString(), timeZone }\n  const event = {\n    summary: `Discussion: ${bid.projectName}`,\n    description: `Proposal discussion for ${bid.projectName} with ${bid.companyName || \"Bidder\"}. Owner: ${ownerName}.`,\n    start,\n    end,\n    attendees: [\n      { email: bid.email },\n      ...attendees.map((e) => ({ email: e })),\n    ],\n    reminders: { useDefault: false, overrides: [{ method: \"email\", minutes: 240 }] },\n    conferenceData: {\n      createRequest: { requestId: `${Date.now()}-${Math.random()}`.replace(/\\./g, \"\"), conferenceSolutionKey: { type: \"hangoutsMeet\" } },\n    },\n  }\n  const { data } = await calendar.events.insert({ calendarId, requestBody: event, conferenceDataVersion: 1 })\n  return { eventId: String(data.id), hangoutLink: data.hangoutLink || undefined, htmlLink: data.htmlLink || undefined, start: start.dateTime, end: end.dateTime }\n}\n\nfunction mailer() {\n  const host = process.env.SMTP_HOST || \"\"\n  const port = Number(process.env.SMTP_PORT || 587)\n  const user = process.env.SMTP_USER || \"\"\n  const pass = process.env.SMTP_PASS || \"\"\n  const from = process.env.SMTP_FROM || \"\"\n  if (!host || !user || !pass || !from) throw new Error(\"Missing SMTP configuration\")\n  const transport = nodemailer.createTransport({ host, port, secure: port === 465, auth: { user, pass } })\n  return { transport, from }\n}\n\nexport async function sendInvitationEmail(to: string, email: InvitationEmail) {\n  const { transport, from } = mailer()\n  const info = await transport.sendMail({ from, to, subject: email.subject, html: email.html })\n  return info.messageId\n}\n\nexport function generateContractAwardPDF(bid: Bid): Promise<Buffer> {\n  return new Promise((resolve, reject) => {\n    const doc = new PDFDocument({ size: \"A4\", margin: 50 })\n    const chunks: Buffer[] = []\n    doc.on(\"data\", (d) => chunks.push(d as Buffer))\n    doc.on(\"end\", () => resolve(Buffer.concat(chunks)))\n    doc.on(\"error\", reject)\n    doc.fontSize(20).text(\"O-BIS Contract Award\", { align: \"center\" })\n    doc.moveDown(1)\n    doc.fontSize(12).text(`Project: ${bid.projectName}`)\n    doc.text(`Company: ${bid.companyName || \"N/A\"}`)\n    doc.text(`Contact: ${bid.contactPerson}`)\n    doc.moveDown(0.5)\n    doc.text(\"Project Information\", { underline: true })\n    doc.moveDown(0.5)\n    doc.text(`Estimated Budget: ${bid.estimatedBudget ?? \"N/A\"}`)\n    doc.text(`Estimated Duration: ${bid.estimatedDuration ? bid.estimatedDuration + \" days\" : \"N/A\"}`)\n    doc.moveDown(0.5)\n    doc.text(\"Project Description\", { underline: true })\n    doc.moveDown(0.5)\n    doc.text(`${bid.description || \"No description provided.\"}`)\n    if (bid.subcontractors && bid.subcontractors.length > 0) {\n      doc.moveDown(0.5)\n      doc.text(\"Subcontractors\", { underline: true })\n      bid.subcontractors.forEach((s, i) => {\n        doc.text(`${i + 1}. ${s.name}${s.company ? \" — \" + s.company : \"\"}${s.scope ? \" — \" + s.scope : \"\"}`)\n      })\n    }\n    doc.moveDown(0.5)\n    doc.text(\"Terms and Conditions\", { underline: true })\n    doc.moveDown(0.5)\n    doc.text(\"All work shall be performed in accordance with O-BIS standards, applicable regulations, and the mutually agreed scope, schedule, and commercial terms.\")\n    doc.moveDown(1)\n    doc.text(\"Authorized Signature:\", { continued: true }).text(\" ____________________________\")\n    doc.moveDown(2)\n    doc.fontSize(10).text(\"O-BIS • Contract Award Document\", { align: \"center\" })\n    doc.end()\n  })\n}\n\nexport function generateContractAwardEmail(bid: Bid, ownerName: string): AwardEmail {\n  const subject = `Contract Award: ${bid.projectName}`\n  const html = `\n  <div style=\"font-family: Arial, sans-serif; color:#111; line-height:1.6;\">\n    <p>Dear ${bid.contactPerson},</p>\n    <p>We are pleased to inform you that O-BIS is awarding the contract for <strong>${bid.projectName}</strong> to <strong>${bid.companyName || \"your organization\"}</strong>.</p>\n    <p>Project Information</p>\n    <ul>\n      <li>Owner: ${ownerName}</li>\n      <li>Estimated Budget: ${bid.estimatedBudget ?? \"N/A\"}</li>\n      <li>Estimated Duration: ${bid.estimatedDuration ? bid.estimatedDuration + \" days\" : \"N/A\"}</li>\n    </ul>\n    <p>Description</p>\n    <p>${bid.description || \"No description provided.\"}</p>\n    <p>Next Steps</p>\n    <p>Please review the attached contract award document. Our team will coordinate kickoff activities and contractual formalities.</p>\n    <p>Sincerely,<br/>O-BIS Management</p>\n  </div>\n  `.trim()\n  return { subject, html }\n}\n\nexport async function sendContractAwardEmail(to: string, email: AwardEmail, pdf: Buffer) {\n  const { transport, from } = mailer()\n  const info = await transport.sendMail({ from, to, subject: email.subject, html: email.html, attachments: [{ filename: \"contract-award.pdf\", content: pdf }] })\n  return info.messageId\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 651, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/constructionplatform%20%281%29/app/api/bids/%5Bid%5D/review/invite/route.ts"],"sourcesContent":["import { NextResponse, NextRequest } from \"next/server\"\r\nimport { prisma } from \"@/lib/db\"\r\nimport { verifyToken } from \"@/lib/auth/jwt\"\r\nimport { createGoogleMeetEvent, generateInvitationEmail, sendInvitationEmail, type Bid as IBid } from \"@/lib/bid-review\"\r\n\r\nfunction getAuthRole(request: NextRequest): { userId: string; role: string } | null {\r\n  const auth = request.headers.get(\"authorization\") || \"\"\r\n  const m = /^Bearer\\s+(.+)$/i.exec(auth)\r\n  if (!m) return null\r\n  const payload = verifyToken(m[1])\r\n  if (!payload) return null\r\n  return { userId: payload.sub, role: payload.role }\r\n}\r\n\r\nexport async function POST(request: NextRequest, { params }: { params: Promise<{ id: string }> }) {\r\n  try {\r\n    const auth = getAuthRole(request)\r\n    if (!auth || (auth.role !== \"manager\" && auth.role !== \"MANAGER\")) {\r\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 })\r\n    }\r\n    const { id } = await params\r\n  const body = await request.json().catch(() => ({}))\r\n  const ownerName: string = body.ownerName || \"Owner\"\r\n  const timeZone: string = body.timeZone || \"UTC\"\r\n  const meetingDate: string | undefined = body.meetingDate\r\n  const meetingTime: string | undefined = body.meetingTime\r\n  const meetUrl: string | undefined = body.meetUrl\r\n  const attendees: string[] = Array.isArray(body.attendees) ? body.attendees : []\r\n\r\n    const bid = await prisma.bid.findUnique({ where: { id } })\r\n    if (!bid) return NextResponse.json({ error: \"Bid not found\" }, { status: 404 })\r\n    const project = await prisma.project.findUnique({ where: { id: bid.projectId } })\r\n    if (!project) return NextResponse.json({ error: \"Project not found\" }, { status: 404 })\r\n\r\n    if (bid.status !== \"Reviewed\") {\r\n      return NextResponse.json({ error: \"Only shortlisted bids can be invited\" }, { status: 400 })\r\n    }\r\n    if ([\"Closed\", \"Awarded\", \"Completed\"].includes(project.status as any)) {\r\n      return NextResponse.json({ error: \"Invitations are disabled for closed or awarded projects\" }, { status: 400 })\r\n    }\r\n\r\n    const bidInput: IBid = {\r\n      contactPerson: bid.bidderName,\r\n      email: bid.email,\r\n      projectName: project.title,\r\n      companyName: bid.companyName || undefined,\r\n      estimatedBudget: (bid as any).amount,\r\n      estimatedDuration: bid.duration,\r\n      description: project.description || bid.message || undefined,\r\n      meetingDate,\r\n      meetingTime,\r\n    }\r\n\r\n    let event\r\n    let finalMeetUrl = \"\"\r\n    if (meetUrl && typeof meetUrl === \"string\") {\r\n      const valid = /^https:\\/\\/meet\\.google\\.com\\/[a-z0-9-]+(\\?.*)?$/i.test(meetUrl)\r\n      if (!valid) {\r\n        return NextResponse.json({ error: \"Invalid Google Meet link\" }, { status: 400 })\r\n      }\r\n      finalMeetUrl = meetUrl\r\n      event = { eventId: \"manual-link\", hangoutLink: meetUrl, start: meetingDate || \"\", end: meetingTime || \"\" }\r\n    } else {\r\n      event = await createGoogleMeetEvent(bidInput, ownerName, timeZone, attendees)\r\n      finalMeetUrl = event.hangoutLink || event.htmlLink || \"\"\r\n    }\r\n    const email = generateInvitationEmail(bidInput, ownerName, timeZone, finalMeetUrl)\r\n\r\n    const recipients = [bid.email, ...attendees].filter(Boolean)\r\n    const messageIds: string[] = []\r\n    for (const to of recipients) {\r\n      const msgId = await sendInvitationEmail(to, email)\r\n      messageIds.push(msgId)\r\n    }\r\n\r\n    return NextResponse.json({ ok: true, event, messageIds })\r\n  } catch (e: any) {\r\n    return NextResponse.json({ error: String(e?.message || \"Failed to send invitation\") }, { status: 500 })\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}}]
}