{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/constructionplatform%20%281%29/lib/storage.ts"],"sourcesContent":["import admin from \"firebase-admin\"\nimport type { Bucket } from \"@google-cloud/storage\"\n\nexport type StorageCategory =\n  | \"bidding-documents\"\n  | \"technical-proposals\"\n  | \"financial-proposals\"\n  | \"procurement-specifications\"\n  | \"vendor-quotations\"\n  | \"contracts\"\n  | \"progress-photos\"\n  | \"proof-of-delivery\"\n\nexport type FirebaseConfig = {\n  projectId: string\n  clientEmail: string\n  privateKey: string\n  bucket: string\n}\n\nexport type UploadOptions = {\n  category: StorageCategory\n  filename: string\n  contentType: string\n  projectId?: string\n  bidId?: string\n  procurementId?: string\n  vendorId?: string\n  userId?: string\n  cacheControl?: string\n  makePublic?: boolean\n  gzip?: boolean\n  metadata?: Record<string, string>\n}\n\nexport type UploadResult = {\n  path: string\n  size: number\n  contentType: string\n  md5Hash?: string\n  generation?: string\n  etag?: string\n  mediaLink?: string\n  publicUrl?: string\n  signedUrl?: string\n}\n\nconst allowedMime = new Set<string>([\n  \"application/pdf\",\n  \"application/msword\",\n  \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n  \"application/vnd.ms-excel\",\n  \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n  \"text/csv\",\n  \"image/jpeg\",\n  \"image/png\",\n])\n\nfunction sanitize(name: string): string {\n  return name\n    .toLowerCase()\n    .replace(/[^a-z0-9_.-]+/g, \"-\")\n    .replace(/-+/g, \"-\")\n    .replace(/^-|-$|^\\.|\\.$/g, \"\")\n}\n\nfunction ts(): string {\n  return new Date().toISOString().replace(/[^0-9]/g, \"\")\n}\n\nfunction buildPath(o: UploadOptions): string {\n  const parts: string[] = [o.category]\n  if (o.projectId) parts.push(`project_${o.projectId}`)\n  if (o.bidId) parts.push(`bid_${o.bidId}`)\n  if (o.procurementId) parts.push(`proc_${o.procurementId}`)\n  if (o.vendorId) parts.push(`vendor_${o.vendorId}`)\n  if (o.userId) parts.push(`user_${o.userId}`)\n  const name = `${ts()}-${sanitize(o.filename)}`\n  parts.push(name)\n  return parts.join(\"/\")\n}\n\nclass FirebaseStorage {\n  private bucket: Bucket\n\n  constructor(cfg: FirebaseConfig) {\n    if (!admin.apps.length) {\n      admin.initializeApp({\n        credential: admin.credential.cert({\n          projectId: cfg.projectId,\n          clientEmail: cfg.clientEmail,\n          privateKey: cfg.privateKey.replace(/\\\\n/g, \"\\n\"),\n        }),\n        storageBucket: cfg.bucket,\n      })\n    }\n    this.bucket = admin.storage().bucket(cfg.bucket)\n  }\n\n  async uploadBuffer(buf: Buffer, opts: UploadOptions): Promise<UploadResult> {\n    if (!allowedMime.has(opts.contentType)) throw new Error(\"Unsupported content type\")\n    const path = buildPath(opts)\n    const file = this.bucket.file(path)\n    await file.save(buf, {\n      contentType: opts.contentType,\n      gzip: opts.gzip ?? true,\n      resumable: false,\n      metadata: { cacheControl: opts.cacheControl ?? \"public, max-age=31536000\", metadata: opts.metadata },\n    })\n    if (opts.makePublic) await file.makePublic()\n    const [meta] = await file.getMetadata()\n    const res: UploadResult = {\n      path,\n      size: Number(meta.size || 0),\n      contentType: meta.contentType || opts.contentType,\n      md5Hash: meta.md5Hash,\n      generation: meta.generation ? String(meta.generation) : undefined,\n      etag: meta.etag,\n      mediaLink: meta.mediaLink,\n      publicUrl: opts.makePublic ? this.getPublicUrl(path) : undefined,\n    }\n    return res\n  }\n\n  async uploadStream(readable: NodeJS.ReadableStream, opts: UploadOptions): Promise<UploadResult> {\n    if (!allowedMime.has(opts.contentType)) throw new Error(\"Unsupported content type\")\n    const path = buildPath(opts)\n    const file = this.bucket.file(path)\n    const ws = file.createWriteStream({\n      contentType: opts.contentType,\n      gzip: opts.gzip ?? true,\n      resumable: false,\n      metadata: { cacheControl: opts.cacheControl ?? \"public, max-age=31536000\", metadata: opts.metadata },\n    })\n    return new Promise<UploadResult>((resolve, reject) => {\n      ws.on(\"error\", reject)\n      ws.on(\"finish\", async () => {\n        try {\n          if (opts.makePublic) await file.makePublic()\n          const [meta] = await file.getMetadata()\n          resolve({\n            path,\n            size: Number(meta.size || 0),\n            contentType: meta.contentType || opts.contentType,\n            md5Hash: meta.md5Hash,\n            generation: meta.generation ? String(meta.generation) : undefined,\n            etag: meta.etag,\n            mediaLink: meta.mediaLink,\n            publicUrl: opts.makePublic ? this.getPublicUrl(path) : undefined,\n          })\n        } catch (e) {\n          reject(e)\n        }\n      })\n      readable.pipe(ws)\n    })\n  }\n\n  async getSignedUrl(path: string, expiresInSeconds: number = 3600): Promise<string> {\n    const file = this.bucket.file(path)\n    const options = { action: \"read\", expires: Date.now() + expiresInSeconds * 1000 } as any\n    const [url] = await file.getSignedUrl(options)\n    return url\n  }\n\n  getPublicUrl(path: string): string {\n    return `https://storage.googleapis.com/${this.bucket.name}/${path}`\n  }\n\n  async delete(path: string): Promise<void> {\n    const file = this.bucket.file(path)\n    await file.delete({ ignoreNotFound: true })\n  }\n\n  async exists(path: string): Promise<boolean> {\n    const file = this.bucket.file(path)\n    const [ok] = await file.exists()\n    return ok\n  }\n\n  async copy(srcPath: string, destPath: string): Promise<void> {\n    const src = this.bucket.file(srcPath)\n    const dest = this.bucket.file(destPath)\n    await src.copy(dest)\n  }\n\n  async move(srcPath: string, destPath: string): Promise<void> {\n    await this.copy(srcPath, destPath)\n    await this.delete(srcPath)\n  }\n\n  async getMetadata(path: string): Promise<Record<string, unknown>> {\n    const file = this.bucket.file(path)\n    const [meta] = await file.getMetadata()\n    return meta\n  }\n}\n\nexport function createFirebaseStorageFromEnv(): FirebaseStorage {\n  const projectId = process.env.FIREBASE_PROJECT_ID || \"\"\n  const clientEmail = process.env.FIREBASE_CLIENT_EMAIL || \"\"\n  const privateKey = (process.env.FIREBASE_PRIVATE_KEY || \"\").replace(/\\r?\\n/g, \"\\n\")\n  const bucket = process.env.FIREBASE_STORAGE_BUCKET || \"\"\n  if (!projectId || !clientEmail || !privateKey || !bucket) throw new Error(\"Missing Firebase credentials\")\n  return new FirebaseStorage({ projectId, clientEmail, privateKey, bucket })\n}\n\nexport { FirebaseStorage }\n"],"names":[],"mappings":"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"}}]
}