{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/constructionplatform%20%281%29/lib/db.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\n\nconst globalForPrisma = globalThis as unknown as { prisma?: PrismaClient }\n\nconst dbUrl = process.env.DATABASE_URL_PGBOUNCER || process.env.DATABASE_URL || \"\"\n\nfunction createPrismaOrMock(): PrismaClient | any {\n  if (dbUrl) {\n    return new PrismaClient({\n      datasources: {\n        db: { url: dbUrl },\n      },\n    })\n  }\n  const warn = (op: string) => {\n    throw new Error(`Database unavailable: set DATABASE_URL before calling ${op}`)\n  }\n  return new Proxy(\n    {},\n    {\n      get(_, prop) {\n        if (prop === \"$use\") return () => {}\n        if (prop === \"$transaction\") return () => warn(\"$transaction\")\n        return () => warn(String(prop))\n      },\n    },\n  ) as PrismaClient\n}\n\nexport const prisma = globalForPrisma.prisma || createPrismaOrMock()\n\nif (!globalForPrisma.prisma) globalForPrisma.prisma = prisma\n\nfunction fmtDate(d: Date): string {\n  const y = d.getFullYear()\n  const m = String(d.getMonth() + 1).padStart(2, \"0\")\n  const day = String(d.getDate()).padStart(2, \"0\")\n  return `${y}-${m}-${day}`\n}\n\nfunction fmtTime(d: Date): string {\n  const h = String(d.getHours()).padStart(2, \"0\")\n  const min = String(d.getMinutes()).padStart(2, \"0\")\n  return `${h}:${min}`\n}\n\nconst TARGET_MODELS = new Set([\n  \"User\",\n  \"Contractor\",\n  \"Vendor\",\n  \"Manager\",\n  \"Project\",\n  \"Bid\",\n  \"BidInvitation\",\n  \"ProcurementRequest\",\n  \"EscrowWalletTransaction\",\n  \"FileStorageRecord\",\n  \"PaymentRequest\",\n  \"Milestone\",\n  \"DailyReport\",\n  \"VendorQuote\",\n])\n\nif (typeof (prisma as any).$use === \"function\") (prisma as any).$use(async (params: any, next: any) => {\n  const now = new Date()\n  const date = fmtDate(now)\n  const time = fmtTime(now)\n  const modelMatches = TARGET_MODELS.has(params.model || \"\")\n  const preventDeletes = String(process.env.ALLOW_DELETE || \"\").toLowerCase() !== \"true\"\n  if (preventDeletes && (params.action === \"delete\" || params.action === \"deleteMany\")) {\n    throw new Error(\"Delete operations are disabled\")\n  }\n\n  if (modelMatches) {\n    if (params.action === \"create\") {\n      params.args.data = { ...(params.args.data || {}), recordDate: date, recordTime: time }\n    } else if (params.action === \"createMany\") {\n      const data = params.args.data\n      if (Array.isArray(data)) {\n        params.args.data = data.map((item: any) => ({ ...(item || {}), recordDate: date, recordTime: time }))\n      } else {\n        params.args.data = { ...(data || {}), recordDate: date, recordTime: time }\n      }\n    } else if (params.action === \"update\" || params.action === \"upsert\") {\n      params.args.data = { ...(params.args.data || {}), recordDate: date, recordTime: time }\n    } else if (params.action === \"updateMany\") {\n      const data = params.args.data\n      params.args.data = { ...(data || {}), recordDate: date, recordTime: time }\n    }\n  }\n\n  return next(params)\n})\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 162, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/constructionplatform%20%281%29/lib/security/bank.ts"],"sourcesContent":["import crypto from \"crypto\"\n\nconst ALGO = \"aes-256-gcm\"\n\nfunction getKey() {\n  const keyB64 = process.env.PAYMENT_ENCRYPTION_KEY || \"\"\n  if (!keyB64) throw new Error(\"Missing PAYMENT_ENCRYPTION_KEY\")\n  const key = Buffer.from(keyB64, \"base64\")\n  if (key.length !== 32) throw new Error(\"PAYMENT_ENCRYPTION_KEY must be 32 bytes base64\")\n  return key\n}\n\nexport function encryptAccountNumber(accountNumber: string): string {\n  const key = getKey()\n  const iv = crypto.randomBytes(12)\n  const cipher = crypto.createCipheriv(ALGO, key, iv)\n  const enc = Buffer.concat([cipher.update(accountNumber, \"utf8\"), cipher.final()])\n  const tag = cipher.getAuthTag()\n  return Buffer.concat([iv, tag, enc]).toString(\"base64\")\n}\n\nexport function decryptAccountNumber(encB64: string): string {\n  const key = getKey()\n  const buf = Buffer.from(encB64, \"base64\")\n  const iv = buf.subarray(0, 12)\n  const tag = buf.subarray(12, 28)\n  const data = buf.subarray(28)\n  const decipher = crypto.createDecipheriv(ALGO, key, iv)\n  decipher.setAuthTag(tag)\n  const dec = Buffer.concat([decipher.update(data), decipher.final()])\n  return dec.toString(\"utf8\")\n}\n\nexport function maskAccountNumber(encB64: string): string {\n  try {\n    const dec = decryptAccountNumber(encB64)\n    const last4 = dec.slice(-4)\n    return `**** **** **** ${last4}`\n  } catch {\n    return \"**** **** **** ****\"\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,MAAM,OAAO;AAEb,SAAS;IACP,MAAM,SAAS,QAAQ,GAAG,CAAC,sBAAsB,IAAI;IACrD,IAAI,CAAC,QAAQ,MAAM,IAAI,MAAM;IAC7B,MAAM,MAAM,OAAO,IAAI,CAAC,QAAQ;IAChC,IAAI,IAAI,MAAM,KAAK,IAAI,MAAM,IAAI,MAAM;IACvC,OAAO;AACT;AAEO,SAAS,qBAAqB,aAAqB;IACxD,MAAM,MAAM;IACZ,MAAM,KAAK,gHAAM,CAAC,WAAW,CAAC;IAC9B,MAAM,SAAS,gHAAM,CAAC,cAAc,CAAC,MAAM,KAAK;IAChD,MAAM,MAAM,OAAO,MAAM,CAAC;QAAC,OAAO,MAAM,CAAC,eAAe;QAAS,OAAO,KAAK;KAAG;IAChF,MAAM,MAAM,OAAO,UAAU;IAC7B,OAAO,OAAO,MAAM,CAAC;QAAC;QAAI;QAAK;KAAI,EAAE,QAAQ,CAAC;AAChD;AAEO,SAAS,qBAAqB,MAAc;IACjD,MAAM,MAAM;IACZ,MAAM,MAAM,OAAO,IAAI,CAAC,QAAQ;IAChC,MAAM,KAAK,IAAI,QAAQ,CAAC,GAAG;IAC3B,MAAM,MAAM,IAAI,QAAQ,CAAC,IAAI;IAC7B,MAAM,OAAO,IAAI,QAAQ,CAAC;IAC1B,MAAM,WAAW,gHAAM,CAAC,gBAAgB,CAAC,MAAM,KAAK;IACpD,SAAS,UAAU,CAAC;IACpB,MAAM,MAAM,OAAO,MAAM,CAAC;QAAC,SAAS,MAAM,CAAC;QAAO,SAAS,KAAK;KAAG;IACnE,OAAO,IAAI,QAAQ,CAAC;AACtB;AAEO,SAAS,kBAAkB,MAAc;IAC9C,IAAI;QACF,MAAM,MAAM,qBAAqB;QACjC,MAAM,QAAQ,IAAI,KAAK,CAAC,CAAC;QACzB,OAAO,CAAC,eAAe,EAAE,OAAO;IAClC,EAAE,OAAM;QACN,OAAO;IACT;AACF"}},
    {"offset": {"line": 228, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/constructionplatform%20%281%29/lib/storage.ts"],"sourcesContent":["import admin from \"firebase-admin\"\nimport type { Bucket } from \"@google-cloud/storage\"\n\nexport type StorageCategory =\n  | \"bidding-documents\"\n  | \"technical-proposals\"\n  | \"financial-proposals\"\n  | \"procurement-specifications\"\n  | \"vendor-quotations\"\n  | \"contracts\"\n  | \"progress-photos\"\n  | \"proof-of-delivery\"\n\nexport type FirebaseConfig = {\n  projectId: string\n  clientEmail: string\n  privateKey: string\n  bucket: string\n}\n\nexport type UploadOptions = {\n  category: StorageCategory\n  filename: string\n  contentType: string\n  projectId?: string\n  bidId?: string\n  procurementId?: string\n  vendorId?: string\n  userId?: string\n  cacheControl?: string\n  makePublic?: boolean\n  gzip?: boolean\n  metadata?: Record<string, string>\n}\n\nexport type UploadResult = {\n  path: string\n  size: number\n  contentType: string\n  md5Hash?: string\n  generation?: string\n  etag?: string\n  mediaLink?: string\n  publicUrl?: string\n  signedUrl?: string\n}\n\nconst allowedMime = new Set<string>([\n  \"application/pdf\",\n  \"application/msword\",\n  \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n  \"application/vnd.ms-excel\",\n  \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n  \"text/csv\",\n  \"image/jpeg\",\n  \"image/png\",\n])\n\nfunction sanitize(name: string): string {\n  return name\n    .toLowerCase()\n    .replace(/[^a-z0-9_.-]+/g, \"-\")\n    .replace(/-+/g, \"-\")\n    .replace(/^-|-$|^\\.|\\.$/g, \"\")\n}\n\nfunction ts(): string {\n  return new Date().toISOString().replace(/[^0-9]/g, \"\")\n}\n\nfunction buildPath(o: UploadOptions): string {\n  const parts: string[] = [o.category]\n  if (o.projectId) parts.push(`project_${o.projectId}`)\n  if (o.bidId) parts.push(`bid_${o.bidId}`)\n  if (o.procurementId) parts.push(`proc_${o.procurementId}`)\n  if (o.vendorId) parts.push(`vendor_${o.vendorId}`)\n  if (o.userId) parts.push(`user_${o.userId}`)\n  const name = `${ts()}-${sanitize(o.filename)}`\n  parts.push(name)\n  return parts.join(\"/\")\n}\n\nclass FirebaseStorage {\n  private bucket: Bucket\n\n  constructor(cfg: FirebaseConfig) {\n    if (!admin.apps.length) {\n      admin.initializeApp({\n        credential: admin.credential.cert({\n          projectId: cfg.projectId,\n          clientEmail: cfg.clientEmail,\n          privateKey: cfg.privateKey.replace(/\\\\n/g, \"\\n\"),\n        }),\n        storageBucket: cfg.bucket,\n      })\n    }\n    this.bucket = admin.storage().bucket(cfg.bucket)\n  }\n\n  async uploadBuffer(buf: Buffer, opts: UploadOptions): Promise<UploadResult> {\n    if (!allowedMime.has(opts.contentType)) throw new Error(\"Unsupported content type\")\n    const path = buildPath(opts)\n    const file = this.bucket.file(path)\n    await file.save(buf, {\n      contentType: opts.contentType,\n      gzip: opts.gzip ?? true,\n      resumable: false,\n      metadata: { cacheControl: opts.cacheControl ?? \"public, max-age=31536000\", metadata: opts.metadata },\n    })\n    if (opts.makePublic) await file.makePublic()\n    const [meta] = await file.getMetadata()\n    const res: UploadResult = {\n      path,\n      size: Number(meta.size || 0),\n      contentType: meta.contentType || opts.contentType,\n      md5Hash: meta.md5Hash,\n      generation: meta.generation ? String(meta.generation) : undefined,\n      etag: meta.etag,\n      mediaLink: meta.mediaLink,\n      publicUrl: opts.makePublic ? this.getPublicUrl(path) : undefined,\n    }\n    return res\n  }\n\n  async uploadStream(readable: NodeJS.ReadableStream, opts: UploadOptions): Promise<UploadResult> {\n    if (!allowedMime.has(opts.contentType)) throw new Error(\"Unsupported content type\")\n    const path = buildPath(opts)\n    const file = this.bucket.file(path)\n    const ws = file.createWriteStream({\n      contentType: opts.contentType,\n      gzip: opts.gzip ?? true,\n      resumable: false,\n      metadata: { cacheControl: opts.cacheControl ?? \"public, max-age=31536000\", metadata: opts.metadata },\n    })\n    return new Promise<UploadResult>((resolve, reject) => {\n      ws.on(\"error\", reject)\n      ws.on(\"finish\", async () => {\n        try {\n          if (opts.makePublic) await file.makePublic()\n          const [meta] = await file.getMetadata()\n          resolve({\n            path,\n            size: Number(meta.size || 0),\n            contentType: meta.contentType || opts.contentType,\n            md5Hash: meta.md5Hash,\n            generation: meta.generation ? String(meta.generation) : undefined,\n            etag: meta.etag,\n            mediaLink: meta.mediaLink,\n            publicUrl: opts.makePublic ? this.getPublicUrl(path) : undefined,\n          })\n        } catch (e) {\n          reject(e)\n        }\n      })\n      readable.pipe(ws)\n    })\n  }\n\n  async getSignedUrl(path: string, expiresInSeconds: number = 3600): Promise<string> {\n    const file = this.bucket.file(path)\n    const options = { action: \"read\", expires: Date.now() + expiresInSeconds * 1000 } as any\n    const [url] = await file.getSignedUrl(options)\n    return url\n  }\n\n  getPublicUrl(path: string): string {\n    return `https://storage.googleapis.com/${this.bucket.name}/${path}`\n  }\n\n  async delete(path: string): Promise<void> {\n    const file = this.bucket.file(path)\n    await file.delete({ ignoreNotFound: true })\n  }\n\n  async exists(path: string): Promise<boolean> {\n    const file = this.bucket.file(path)\n    const [ok] = await file.exists()\n    return ok\n  }\n\n  async copy(srcPath: string, destPath: string): Promise<void> {\n    const src = this.bucket.file(srcPath)\n    const dest = this.bucket.file(destPath)\n    await src.copy(dest)\n  }\n\n  async move(srcPath: string, destPath: string): Promise<void> {\n    await this.copy(srcPath, destPath)\n    await this.delete(srcPath)\n  }\n\n  async getMetadata(path: string): Promise<Record<string, unknown>> {\n    const file = this.bucket.file(path)\n    const [meta] = await file.getMetadata()\n    return meta\n  }\n}\n\nexport function createFirebaseStorageFromEnv(): FirebaseStorage {\n  const projectId = process.env.FIREBASE_PROJECT_ID || \"\"\n  const clientEmail = process.env.FIREBASE_CLIENT_EMAIL || \"\"\n  const privateKey = (process.env.FIREBASE_PRIVATE_KEY || \"\").replace(/\\r?\\n/g, \"\\n\")\n  const bucket = process.env.FIREBASE_STORAGE_BUCKET || \"\"\n  if (!projectId || !clientEmail || !privateKey || !bucket) throw new Error(\"Missing Firebase credentials\")\n  return new FirebaseStorage({ projectId, clientEmail, privateKey, bucket })\n}\n\nexport { FirebaseStorage }\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 399, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/constructionplatform%20%281%29/lib/server/payment-requests.ts"],"sourcesContent":["import { prisma } from \"@/lib/db\"\nimport { encryptAccountNumber } from \"@/lib/security/bank\"\nimport { createFirebaseStorageFromEnv } from \"@/lib/storage\"\n\nexport async function processPaymentRequest(request: Request, payload: { sub: string; role: \"contractor\" | \"vendor\" }) {\n  const ct = request.headers.get(\"content-type\") || \"\"\n  let data: any = {}\n  let proofUrl = \"\"\n  let proofMeta: any = {}\n  if (ct.includes(\"multipart/form-data\")) {\n    const form = await request.formData()\n    data = {\n      projectId: form.get(\"projectId\")?.toString(),\n      amount: form.get(\"amount\")?.toString(),\n      bankName: form.get(\"bankName\")?.toString(),\n      branch: form.get(\"branch\")?.toString(),\n      accountType: form.get(\"accountType\")?.toString(),\n      accountNumber: form.get(\"accountNumber\")?.toString(),\n    }\n    const file = form.get(\"proof\") as File | null\n    if (file) {\n      const storage = createFirebaseStorageFromEnv()\n      const buffer = Buffer.from(await file.arrayBuffer())\n      const up = await storage.uploadBuffer(buffer, {\n        category: \"proof-of-delivery\",\n        filename: file.name || \"proof\",\n        contentType: file.type || \"application/octet-stream\",\n        projectId: data.projectId,\n        userId: payload.sub,\n      })\n      proofUrl = up.publicUrl || up.mediaLink || storage.getPublicUrl(up.path)\n      proofMeta = { path: up.path, contentType: up.contentType, size: up.size }\n    }\n  } else {\n    data = await request.json().catch(() => ({}))\n    proofUrl = data.proofUrl || \"\"\n    if (!proofUrl && typeof data.proofDataUrl === \"string\") {\n      const storage = createFirebaseStorageFromEnv()\n      const b64 = data.proofDataUrl.split(\",\")[1]\n      const buffer = Buffer.from(b64, \"base64\")\n      const up = await storage.uploadBuffer(buffer, {\n        category: \"proof-of-delivery\",\n        filename: data.proofFilename || \"proof\",\n        contentType: data.proofContentType || \"application/octet-stream\",\n        projectId: data.projectId,\n        userId: payload.sub,\n      })\n      proofUrl = up.publicUrl || up.mediaLink || storage.getPublicUrl(up.path)\n      proofMeta = { path: up.path, contentType: up.contentType, size: up.size }\n    }\n  }\n\n  if (!data.amount || Number(data.amount) <= 0) throw new Error(\"Invalid amount\")\n  for (const k of [\"bankName\", \"branch\", \"accountType\", \"accountNumber\"]) {\n    if (!data[k]) throw new Error(`Missing ${k}`)\n  }\n  if (!proofUrl) throw new Error(\"Proof of delivery is required\")\n\n  const encAcc = encryptAccountNumber(String(data.accountNumber))\n  const now = new Date()\n  const y = now.getFullYear()\n  const mm = String(now.getMonth() + 1).padStart(2, \"0\")\n  const d = String(now.getDate()).padStart(2, \"0\")\n  const h = String(now.getHours()).padStart(2, \"0\")\n  const min = String(now.getMinutes()).padStart(2, \"0\")\n  const recordDate = `${y}-${mm}-${d}`\n  const recordTime = `${h}:${min}`\n  const created = await prisma.paymentRequest.create({\n    data: {\n      userId: payload.sub,\n      userType: payload.role as any,\n      projectId: data.projectId || null,\n      amount: data.amount,\n      bankName: data.bankName,\n      branch: data.branch,\n      accountType: data.accountType,\n      accountNumberEnc: encAcc,\n      proofUrl,\n      proofPath: proofMeta.path,\n      proofContentType: proofMeta.contentType,\n      proofSize: proofMeta.size,\n      recordDate,\n      recordTime,\n    },\n  })\n  return created\n}\n\nexport async function calculateWalletBalance(userId: string) {\n  const [creditsAgg, debitsAgg] = await Promise.all([\n    prisma.escrowWalletTransaction.aggregate({ where: { userId, type: { in: [\"received\", \"refunded\"] as any } }, _sum: { amount: true } }),\n    prisma.escrowWalletTransaction.aggregate({ where: { userId, type: { in: [\"requested\", \"withdrawn\"] as any } }, _sum: { amount: true } }),\n  ])\n  const credits = Number(creditsAgg._sum.amount || 0)\n  const debits = Number(debitsAgg._sum.amount || 0)\n  return credits - debits\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAEO,eAAe,sBAAsB,OAAgB,EAAE,OAAuD;IACnH,MAAM,KAAK,QAAQ,OAAO,CAAC,GAAG,CAAC,mBAAmB;IAClD,IAAI,OAAY,CAAC;IACjB,IAAI,WAAW;IACf,IAAI,YAAiB,CAAC;IACtB,IAAI,GAAG,QAAQ,CAAC,wBAAwB;QACtC,MAAM,OAAO,MAAM,QAAQ,QAAQ;QACnC,OAAO;YACL,WAAW,KAAK,GAAG,CAAC,cAAc;YAClC,QAAQ,KAAK,GAAG,CAAC,WAAW;YAC5B,UAAU,KAAK,GAAG,CAAC,aAAa;YAChC,QAAQ,KAAK,GAAG,CAAC,WAAW;YAC5B,aAAa,KAAK,GAAG,CAAC,gBAAgB;YACtC,eAAe,KAAK,GAAG,CAAC,kBAAkB;QAC5C;QACA,MAAM,OAAO,KAAK,GAAG,CAAC;QACtB,IAAI,MAAM;YACR,MAAM,UAAU,IAAA,gJAA4B;YAC5C,MAAM,SAAS,OAAO,IAAI,CAAC,MAAM,KAAK,WAAW;YACjD,MAAM,KAAK,MAAM,QAAQ,YAAY,CAAC,QAAQ;gBAC5C,UAAU;gBACV,UAAU,KAAK,IAAI,IAAI;gBACvB,aAAa,KAAK,IAAI,IAAI;gBAC1B,WAAW,KAAK,SAAS;gBACzB,QAAQ,QAAQ,GAAG;YACrB;YACA,WAAW,GAAG,SAAS,IAAI,GAAG,SAAS,IAAI,QAAQ,YAAY,CAAC,GAAG,IAAI;YACvE,YAAY;gBAAE,MAAM,GAAG,IAAI;gBAAE,aAAa,GAAG,WAAW;gBAAE,MAAM,GAAG,IAAI;YAAC;QAC1E;IACF,OAAO;QACL,OAAO,MAAM,QAAQ,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC3C,WAAW,KAAK,QAAQ,IAAI;QAC5B,IAAI,CAAC,YAAY,OAAO,KAAK,YAAY,KAAK,UAAU;YACtD,MAAM,UAAU,IAAA,gJAA4B;YAC5C,MAAM,MAAM,KAAK,YAAY,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE;YAC3C,MAAM,SAAS,OAAO,IAAI,CAAC,KAAK;YAChC,MAAM,KAAK,MAAM,QAAQ,YAAY,CAAC,QAAQ;gBAC5C,UAAU;gBACV,UAAU,KAAK,aAAa,IAAI;gBAChC,aAAa,KAAK,gBAAgB,IAAI;gBACtC,WAAW,KAAK,SAAS;gBACzB,QAAQ,QAAQ,GAAG;YACrB;YACA,WAAW,GAAG,SAAS,IAAI,GAAG,SAAS,IAAI,QAAQ,YAAY,CAAC,GAAG,IAAI;YACvE,YAAY;gBAAE,MAAM,GAAG,IAAI;gBAAE,aAAa,GAAG,WAAW;gBAAE,MAAM,GAAG,IAAI;YAAC;QAC1E;IACF;IAEA,IAAI,CAAC,KAAK,MAAM,IAAI,OAAO,KAAK,MAAM,KAAK,GAAG,MAAM,IAAI,MAAM;IAC9D,KAAK,MAAM,KAAK;QAAC;QAAY;QAAU;QAAe;KAAgB,CAAE;QACtE,IAAI,CAAC,IAAI,CAAC,EAAE,EAAE,MAAM,IAAI,MAAM,CAAC,QAAQ,EAAE,GAAG;IAC9C;IACA,IAAI,CAAC,UAAU,MAAM,IAAI,MAAM;IAE/B,MAAM,SAAS,IAAA,iJAAoB,EAAC,OAAO,KAAK,aAAa;IAC7D,MAAM,MAAM,IAAI;IAChB,MAAM,IAAI,IAAI,WAAW;IACzB,MAAM,KAAK,OAAO,IAAI,QAAQ,KAAK,GAAG,QAAQ,CAAC,GAAG;IAClD,MAAM,IAAI,OAAO,IAAI,OAAO,IAAI,QAAQ,CAAC,GAAG;IAC5C,MAAM,IAAI,OAAO,IAAI,QAAQ,IAAI,QAAQ,CAAC,GAAG;IAC7C,MAAM,MAAM,OAAO,IAAI,UAAU,IAAI,QAAQ,CAAC,GAAG;IACjD,MAAM,aAAa,GAAG,EAAE,CAAC,EAAE,GAAG,CAAC,EAAE,GAAG;IACpC,MAAM,aAAa,GAAG,EAAE,CAAC,EAAE,KAAK;IAChC,MAAM,UAAU,MAAM,qHAAM,CAAC,cAAc,CAAC,MAAM,CAAC;QACjD,MAAM;YACJ,QAAQ,QAAQ,GAAG;YACnB,UAAU,QAAQ,IAAI;YACtB,WAAW,KAAK,SAAS,IAAI;YAC7B,QAAQ,KAAK,MAAM;YACnB,UAAU,KAAK,QAAQ;YACvB,QAAQ,KAAK,MAAM;YACnB,aAAa,KAAK,WAAW;YAC7B,kBAAkB;YAClB;YACA,WAAW,UAAU,IAAI;YACzB,kBAAkB,UAAU,WAAW;YACvC,WAAW,UAAU,IAAI;YACzB;YACA;QACF;IACF;IACA,OAAO;AACT;AAEO,eAAe,uBAAuB,MAAc;IACzD,MAAM,CAAC,YAAY,UAAU,GAAG,MAAM,QAAQ,GAAG,CAAC;QAChD,qHAAM,CAAC,uBAAuB,CAAC,SAAS,CAAC;YAAE,OAAO;gBAAE;gBAAQ,MAAM;oBAAE,IAAI;wBAAC;wBAAY;qBAAW;gBAAQ;YAAE;YAAG,MAAM;gBAAE,QAAQ;YAAK;QAAE;QACpI,qHAAM,CAAC,uBAAuB,CAAC,SAAS,CAAC;YAAE,OAAO;gBAAE;gBAAQ,MAAM;oBAAE,IAAI;wBAAC;wBAAa;qBAAY;gBAAQ;YAAE;YAAG,MAAM;gBAAE,QAAQ;YAAK;QAAE;KACvI;IACD,MAAM,UAAU,OAAO,WAAW,IAAI,CAAC,MAAM,IAAI;IACjD,MAAM,SAAS,OAAO,UAAU,IAAI,CAAC,MAAM,IAAI;IAC/C,OAAO,UAAU;AACnB"}},
    {"offset": {"line": 562, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/constructionplatform%20%281%29/lib/auth/jwt.ts"],"sourcesContent":["import jwt from \"jsonwebtoken\"\n\ntype Payload = { sub: string; role: \"manager\" | \"contractor\" | \"vendor\" }\n\nexport function signToken(payload: Payload, expiresIn: string = process.env.JWT_EXPIRES_IN || \"1h\") {\n  const secret = process.env.JWT_SECRET || \"\"\n  if (!secret) throw new Error(\"Missing JWT_SECRET\")\n  return jwt.sign(payload, secret as jwt.Secret, { algorithm: \"HS256\", expiresIn } as jwt.SignOptions)\n}\n\nexport function verifyToken(token: string): Payload | null {\n  const secret = process.env.JWT_SECRET || \"\"\n  if (!secret) throw new Error(\"Missing JWT_SECRET\")\n  try {\n    return jwt.verify(token, secret) as Payload\n  } catch {\n    return null\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAIO,SAAS,UAAU,OAAgB,EAAE,YAAoB,QAAQ,GAAG,CAAC,cAAc,IAAI,IAAI;IAChG,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU,IAAI;IACzC,IAAI,CAAC,QAAQ,MAAM,IAAI,MAAM;IAC7B,OAAO,kJAAG,CAAC,IAAI,CAAC,SAAS,QAAsB;QAAE,WAAW;QAAS;IAAU;AACjF;AAEO,SAAS,YAAY,KAAa;IACvC,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU,IAAI;IACzC,IAAI,CAAC,QAAQ,MAAM,IAAI,MAAM;IAC7B,IAAI;QACF,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAM;QACN,OAAO;IACT;AACF"}},
    {"offset": {"line": 591, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/constructionplatform%20%281%29/app/api/wallet/%5BuserId%5D/route.ts"],"sourcesContent":["import { NextResponse, NextRequest } from \"next/server\"\nimport { prisma } from \"@/lib/db\"\nimport { calculateWalletBalance } from \"@/lib/server/payment-requests\"\nimport { verifyToken } from \"@/lib/auth/jwt\"\n\nfunction isAuthorized(payload: any, userId: string): boolean {\n  if (!payload) return false\n  if (payload.sub === userId) return true\n  if (payload.role === \"manager\") return true\n  return false\n}\n\nexport async function GET(request: NextRequest, { params }: { params: Promise<{ userId: string }> }) {\n  try {\n    const auth = request.headers.get(\"authorization\") || \"\"\n    const m = /^Bearer\\s+(.+)$/i.exec(auth)\n    if (!m) return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\n    const payload = verifyToken(m[1])\n    const { userId } = await params\n    if (!isAuthorized(payload, userId)) return NextResponse.json({ error: \"Forbidden\" }, { status: 403 })\n\n    const [balance, pendingAgg] = await Promise.all([\n      calculateWalletBalance(userId),\n      prisma.paymentRequest.aggregate({ where: { userId, status: \"PENDING\" as any }, _sum: { amount: true } }),\n    ])\n    const pending = Number(pendingAgg._sum.amount || 0)\n    return NextResponse.json({ userId, balance, pending })\n  } catch (e: any) {\n    return NextResponse.json({ error: String(e?.message || \"Failed to load wallet summary\") }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEA,SAAS,aAAa,OAAY,EAAE,MAAc;IAChD,IAAI,CAAC,SAAS,OAAO;IACrB,IAAI,QAAQ,GAAG,KAAK,QAAQ,OAAO;IACnC,IAAI,QAAQ,IAAI,KAAK,WAAW,OAAO;IACvC,OAAO;AACT;AAEO,eAAe,IAAI,OAAoB,EAAE,EAAE,MAAM,EAA2C;IACjG,IAAI;QACF,MAAM,OAAO,QAAQ,OAAO,CAAC,GAAG,CAAC,oBAAoB;QACrD,MAAM,IAAI,mBAAmB,IAAI,CAAC;QAClC,IAAI,CAAC,GAAG,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;QAC1E,MAAM,UAAU,IAAA,mIAAW,EAAC,CAAC,CAAC,EAAE;QAChC,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM;QACzB,IAAI,CAAC,aAAa,SAAS,SAAS,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAY,GAAG;YAAE,QAAQ;QAAI;QAEnG,MAAM,CAAC,SAAS,WAAW,GAAG,MAAM,QAAQ,GAAG,CAAC;YAC9C,IAAA,gKAAsB,EAAC;YACvB,qHAAM,CAAC,cAAc,CAAC,SAAS,CAAC;gBAAE,OAAO;oBAAE;oBAAQ,QAAQ;gBAAiB;gBAAG,MAAM;oBAAE,QAAQ;gBAAK;YAAE;SACvG;QACD,MAAM,UAAU,OAAO,WAAW,IAAI,CAAC,MAAM,IAAI;QACjD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;YAAQ;YAAS;QAAQ;IACtD,EAAE,OAAO,GAAQ;QACf,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,OAAO,GAAG,WAAW;QAAiC,GAAG;YAAE,QAAQ;QAAI;IAC3G;AACF"}}]
}